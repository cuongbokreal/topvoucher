
<html>
  <head>
    <meta charset='UTF-8'/>
    <meta content='width=device-width, initial-scale=1, user-scalable=1, minimum-scale=1, maximum-scale=5' name='viewport'/>
    <meta content='IE=edge' http-equiv='X-UA-Compatible'/>
    <title>Tạo Deeplink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
  </head>
  <body>
    <div id="main">
        <p>Id CTV: <span class="text-danger" id="ctv_id"></span></p>
        <h4>Tạo Deeplink</h4>
        <input id="linkSp" placeholder="Nhập link gốc" onblur="createDeeplink()" onclick="this.select()"/>
      <p id="thbao">Link sai hoặc lỗi nhập id</p>
        <button class="button" id="btnDeplink" onclick="createDeeplink()">Tạo</button>
        <textarea id="kqDeeplink" placeholder="Kết quả (Nhấn để copy)" onclick="copyValue(this)" readonly></textarea>
      
      
      <div id="iframeShort">
        <p>Tạo ShortLink<span id="refreshFrame" onclick="refreshShort()">Làm mới <i class="fa-solid fa-arrows-rotate"></i></span></p>
        <iframe scrolling="no" id="short" src="https://bitly.com.vn/#short" ></iframe>
      </div>
      <!-- https://bom.so/#main-form -->
      
        <div id="infor_camp"></div>
      <div>
        <b>Lưu ý:</b>
        <p>Khi nhấn tạo link đã tự động copy Deeplink.</p>
        <p>Link rút gọn chỉ tồn tại trong 20 ngày. (hoặc có thể dùng <a target="_blank" rel="nofollow" href="https://bitly.com/">https://bitly.com/</a>, link sẽ tồn tại vĩnh viễn)</p>
      </div>
        </div>

      
    <script>
      var getUrlParameter = function getUrlParameter(sParam) {
      var sPageURL = window.location.search.substring(1), sURLVariables = sPageURL.split('&'), sParameterName, i;
      for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=');
          if (sParameterName[0] === sParam) {
              return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
          }
      }
  };
      var ctv_id = getUrlParameter('id');
      if(typeof ctv_id != 'undefined'){
        if (ctv_id.length >= 6){
          document.getElementById('ctv_id').innerHTML = ctv_id;
        }else
        if(ctv_id.length < 6){
          window.location.href = 'https://topvoucher.tk/ctv/tools/create/deep-link/access/'
        }
      }
        if(typeof ctv_id == 'undefined'){
          window.location.href = 'https://topvoucher.tk/ctv/tools/create/deep-link/access/'
        }
        
      
      var source = `&utm_source=ctv&utm_medium=ctv_${ctv_id}&utm_campaign=createDeepLink&utm_content=-`;
      
      var deeplink = 'https://go.isclix.com/deep_link/5353514789844343379';
      var thbao = document.getElementById('thbao');
      var btnDeplink = document.getElementById('btnDeplink');
      var kqDeeplink = document.getElementById('kqDeeplink');
      var infor_camp = document.getElementById('infor_camp');
      var data_ad = [
        {"name":"Shopee",
         "reg":"shopee",
         "camp_id":"4751584435713464237"
        },
        {"name":"Lazada",
         "reg":"lazada",
         "camp_id":"5087153089503673507"
        },
        {"name":"Tiki",
         "reg":"tiki",
         "camp_id":"4348614231480407268"
        },
      ]
      var kq = '';
      var data_infor_camp = '';
      function createDeeplink(){
        thbao.style.display = 'none';
        var finalLink = '';
        var linkSp = document.getElementById('linkSp').value;
        
        if(linkSp.match(/shopee\.vn/g)){
          
          if(linkSp.match(/promotionId/g) || linkSp.match(/signature/g) || linkSp.match(/evcode/g)){
            var evcode = linkSp.match(/evcode=?([a-zA-Z0-9]+)/g);
            var promotionId = linkSp.match(/&promotionId=?([0-9]+)/g);
            var signature = linkSp.match(/&signature=?([a-zA-Z0-9]+)/g);
            finalLink = encodeURIComponent(`https://shopee.vn/search?${evcode}${promotionId}${signature}`);
          }else 
          if(linkSp.match(/i\..+\?/g)){
            var idSp = linkSp.match(/i\..+\?/g)
            finalLink = `https://shopee.vn/TrumGiamGia.Tk-${idSp}`;
            finalLink = encodeURIComponent(finalLink.replaceAll("?",""));
          }else 
          if(linkSp.match(/https:\/\/shopee.vn\/.+\?/)){
            finalLink = linkSp.match(/https:\/\/shopee.vn\/.+\?/);
            finalLink = encodeURIComponent(finalLink[0].replaceAll("?",""));
          }else{
            finalLink = linkSp.match(/http.+/g);
            finalLink = encodeURIComponent(finalLink[0].replaceAll(/\?.+/g,""));
          }
          
          kq = `${deeplink}/${data_ad[0].camp_id}?url=${finalLink}${source}`;
          data_infor_camp = `<p>Tên camp: <span style="color:red">${data_ad[0].name}</span></p> 
                             <p>Link gốc: <span style="color:red">${decodeURIComponent(finalLink)}</span></p> 
                             <p>Tracking link: <span style="color:red">${kq}</span></p>`;
        } else
          
        if(linkSp.match(/lazada\.vn/g)){
          if(linkSp.match(/https:\/\/(pages|www)\.lazada\.vn.+?laz_trackid/g)){
            finalLink = linkSp.match(/https:\/\/(pages|www)\.lazada\.vn.+?laz_trackid/g);
            //add '?referer=at-kol'
            if(finalLink.match(/(\?|\&)referer=at-kol/g)){}
            else{ 
              if(finalLink.match(/\?/g)){finalLink += '&referer=at-kol';}
              else{finalLink += '?referer=at-kol';}
                }
            finalLink = encodeURIComponent(finalLink[0].replace("laz_trackid"," ").replace(/(\?\s|&\s)/g,""));
          }else{
            //add '?referer=at-kol'
            if(finalLink.match(/(\?|\&)referer=at-kol/g)){}
            else{ 
              if(finalLink.match(/\?/g)){finalLink += '&referer=at-kol';}
              else{finalLink += '?referer=at-kol';}
                }
            finalLink = encodeURIComponent(linkSp);
          }
          
          
          kq = `${deeplink}/${data_ad[1].camp_id}?url=${finalLink}${source}`;
          data_infor_camp = `<p>Tên camp: <span style="color:red">${data_ad[1].name}</span></p> 
                             <p>Link gốc: <span style="color:red">${decodeURIComponent(finalLink)}</span></p> 
                             <p>Tracking link: <span style="color:red">${kq}</span></p>`;
        } else
          
        if(linkSp.match(/tiki\.vn/g)){
          
          finalLink = linkSp.match(/http.+\?/g);
          finalLink = encodeURIComponent(finalLink[0].replaceAll("?",""));
          
          kq = `${deeplink}/${data_ad[2].camp_id}?url=${finalLink}${source}`;
          data_infor_camp = `<p>Tên camp: <span style="color:red">${data_ad[2].name}</span></p> 
                             <p>Link gốc: <span style="color:red">${decodeURIComponent(finalLink)}</span></p> 
                             <p>Tracking link: <span style="color:red">${kq}</span></p>`;
        } else{thbao.style.display = '';}
        
        kqDeeplink.value = kq;
        infor_camp.innerHTML = data_infor_camp;
        
        //copy
        var copyText = document.getElementById('kqDeeplink');
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        console.log("Copied: " + copyText.value);
        
        //document.getElementById('refreshFrame').click();
        document.getElementById('short').src = '';
        document.getElementById('short').src = 'https://bitly.com.vn/#short';
      }
      
      function refreshShort(){
        //document.getElementById('short').contentWindow.location.reload();
        document.getElementById('short').src = '';
        document.getElementById('short').src = 'https://bitly.com.vn/#short';
      }
      function copyValue(s){
        s.focus();
        s.select();
        document.execCommand("Copy");
        console.log(`Copied: ${s.value}`);
      }
    </script>
    <style>
      #main{padding:10px}
      input {font-family: "Roboto", sans-serif;outline: 0;background: #f2f2f2;width: 100%;height:65px; border: 1px solid #cecece; margin: 10 0 15px;padding: 15px;box-sizing: border-box;font-size: 14px;}
      .button {font-family: "Roboto", sans-serif;text-transform: uppercase;outline: 0;background: #4CAF50;border: 1px solid #ffffff00 ;width: 25%;padding: 15px;color: #FFFFFF;font-size: 14px;-webkit-transition: all 0.3 ease;transition: all 0.3 ease;cursor: pointer;}
      .button:hover,.button:active,.button:focus {background: #43A047;}
      .button:hover {box-shadow: 0 12px 16px 0 rgba(0,0,0,0.09), 0 17px 50px 0 rgba(0,0,0,0.09);}  
      textarea{width:100%;height:60px;margin-top:10px;background: #e5e5e5; border: 1px solid #cecece; max-width: 100%;}
      .text-danger, .text-red {color: #e55039!important;}
      
      #linkSp{padding: 0.375rem 0.75rem;font-size: .875rem;font-weight: 400;line-height: 1.5;color: #4f5467;background-color: #fff;background-clip: padding-box;border: 1px solid #bfbfbf;border-radius: 2px;outline:none}
      #kqDeeplink{background-color: #e9ecef;color: #4f5467;padding: 0.375rem 0.75rem;border: none;border-radius: 2px;outline: none;}
      
      #thbao{display:none}
      #refreshFrame{cursor:pointer; margin:10px 0 0 5px; color: #0abde3!important;}
      #iframeShort{border: 1px solid #cecece;margin-top: 25px;}
      #short{width:100%;height: 25%; border: 0; overflow: hidden;}
      #infor_camp{line-break: anywhere;}
      
      @media screen and (max-width:640px){
        #short{height: 30%}
      }
    </style>
  </body>
</html>
